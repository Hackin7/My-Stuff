<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>CTF Writeup</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/style.css"/>

  </head>

  <body>
    <!--Navigation Bar-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="/index.html">Hackin7</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarText">
        <ul class="navbar-nav mr-auto">

          <li class="nav-item">
            <a class="nav-link" href="/about.html">About</a></li>
           <li><a class="nav-link" href="/achievements.html">Achievements</a></li>
           <li><a class="nav-link" href="/blog.html">Blog</a></li>
            <li><a class="nav-link" href="/links.html">CTF Writeups</a></li>
            <li><a class="nav-link" href="/all_projects.html">All Projects</a></li>
        </ul>
      </div>
    </nav>

    <div>
    
    <div class='content'>
    <link href='/css/github-css.css' rel='stylesheet' type='text/css'>
        <br>
        <a href='https://github.com/Hackin7/Programming-Crappy-Solutions/blob/master/Cyber Security/Capture the Flag Competitions/2020/STACK the Flags/Mobile'>Original Github Link</a><br>
        <h1>Mobile</h1>
<p>The mobile challenges all use 1 apk, so they are all actually interlinked. As such, I decided to combine all of the challenges I did into 1 writeup.</p>
<h2>Challenges Done</h2>
<h3>Contact Us!</h3>
<p>790, MOBILE, 29 SOLVES</p>
<h4>Description</h4>
<p>Looks like Korovax has exposed some development comment lines accidentally. Can you get one of the secrets through this mistake?</p>
<hr />
<h3>Subscribe!</h3>
<p>863, MOBILE, 25 SOLVES</p>
<h4>Description</h4>
<p>Korovax would like to keep its users informed about the latest updates of COViD, and there's nothing better but to spam your emails!</p>
<hr />
<h3>Welcome to Korovax Mobile!</h3>
<p>1874, MOBILE, 19 SOLVES</p>
<h4>Description</h4>
<p>To be part of the Korovax team, do you really need to sign up to be a member?</p>
<p>Please view this Document for download instructions.</p>
<p>This challenge:</p>
<ul>
<li>Unlocks other challenge(s)</li>
</ul>
<hr />
<h3>True or false?</h3>
<p>1962, MOBILE, 11 SOLVES</p>
<h4>Description</h4>
<p>True or false, we can log in as admin easily.</p>
<p>Please view this Document for download instructions.</p>
<p>This challenge:</p>
<ul>
<li>Unlocks other challenge(s)</li>
<li>Is eligible for Awesome Write-ups Award</li>
<li>Prerequisite for Mastery Award - Mobile Ace</li>
</ul>
<hr />
<h3>What's with the Search!</h3>
<p>984, MOBILE, 10 SOLVES</p>
<h4>Description</h4>
<p>There is an admin dashboard in the Korovax mobile. There aren't many functions, but we definitely can search for something!</p>
<p>This challenge:</p>
<ul>
<li>Unlocks other challenge(s)</li>
<li>Is eligible for Awesome Write-ups Award</li>
<li>Prerequisite for Mastery Award - Mobile Ace</li>
</ul>
<hr />
<h3>All about Korovax!</h3>
<p>984, MOBILE, 10 SOLVES</p>
<h4>Description</h4>
<p>As a user and member of Korovax mobile, you will be treated with a lot of information about COViD and a few in-app functions that should help you understand more about COViD and Korovax! Members should be glad that they even have a notepad in there, to create notes as they learn more about Korovax's mission!</p>
<p>This challenge:</p>
<ul>
<li>Unlocks other challenge(s)</li>
<li>Is eligible for Awesome Write-ups Award</li>
</ul>
<h2>Solution</h2>
<h3>Standard Decompilation</h3>
<p>Whenever I have an apk, I decompile them. For this challenge, I used <a href="https://www.apkdecompilers.com/">https://www.apkdecompilers.com/</a></p>
<p>I then tried finding the flag using grep (expecting it to be hidden in Java Comments) <a href="https://stackoverflow.com/questions/16956810/how-do-i-find-all-files-containing-specific-text-on-linux">https://stackoverflow.com/questions/16956810/how-do-i-find-all-files-containing-specific-text-on-linux</a></p>
<pre><code>$ grep -rnw './' -e 'govtech-csg{'
Binary file ./resources/classes.dex matches
./sources/sg/gov/tech/ctf/mobile/Admin/AdminHome.java:95:                ((TextView) view.findViewById(R.id.alert_detail)).setText(&quot;Add govtech-csg{} to what you found!&quot;);
./sources/sg/gov/tech/ctf/mobile/Admin/AdminHome.java:126:        if (!enteredFlagString.contains(&quot;govtech-csg{&quot;)) {
./sources/sg/gov/tech/ctf/mobile/Admin/AdminHome.java:129:        String result = enteredFlagString.replace(&quot;govtech-csg{&quot;, BuildConfig.FLAVOR);
</code></pre>
<p>Welp looks like little progress. I downloaded and ran the application on my phone to test. <del>Also I was too lazy to care if it was malware since past CTF challenges on mobile had no malware so I just installed it on my phone. Don't be like me</del></p>
<h3>Native Libraries (Contact Me! and Subscribe!)</h3>
<p>Looking around all the activities, the Introduction Activity looks like it's just displaying static text. The MainActivity seems normal.
For the first challenge <code>Contact Us!</code>, I think it makes sense to check the Contact page. on my phone</p>
<p>They said cheat code is abracadabra. I tried entering it in but it just gives a unique error message</p>
<p><img src="Images/screenshot_contact_1.jpg" alt="" /></p>
<p>Looking at the code in greater detail, there were these <code>native</code> functions <code>check</code>, <code>retrieveFlag</code> and <code>retrieveFlag2</code>. The most important one was <code>retrieveFlag2</code> since it was the one used.</p>
<p>From <code>Decompiled/sources/sg/gov/tech/ctf/mobile/ContactForm.java</code></p>
<p><img src="Images/code_contact_1.png" alt="" />
<img src="Images/code_contact_2.png" alt="" /></p>
<p>On googling what native means, I realised it is the Java Native Interface, and there are actually binary files.
I decompiled a native library file which looked correct and got the comment</p>
<p><img src="Images/code_native_1.jpg" alt="" /></p>
<p>Putting it in the app you get one answer</p>
<p>The next challenge <code>Subscribe!</code> is similar. There's an important native function used in <code>ContactForm.java</code>, so find it in the decompiled library file, and you have the flag right in the code</p>
<p><img src="Images/code_contact_3.jpg" alt="" /></p>
<p>Putting <code>govtech-csg{th3rE_15_nO_n0bIliTy_In_p0Vert7}</code> into the Subscribe! section of the ContactForm of the app gives a Congrats! message .</p>
<p><img src="Images/screenshot_contact_2.jpg" alt="" /></p>
<h3>Reversing (Welcome to Korovax Mobile!, True or False)</h3>
<p>On first look at the code, I didn't understand what it meant</p>
<p>Looking at the single letter variable names and classes, I wondered if the code was obfuscated, and through googling, and with the help of  <a href="https://stackoverflow.com/questions/28423427/after-decompile-apk-why-class-names-and-object-are-letter">stackoverflow</a>, find out that it is through obfuscation. I googled for and used a deobfuscator <a href="http://apk-deguard.com/">apk-deguard</a>, and saved the code.</p>
<p>After getting the hint which was totally useless and can even be found in the app, I decided to take a closer look at the User and Admin Authentication Activities</p>
<p><img src="Images/screenshot_user_authentication.jpg" alt="haha cannot take screenshot because of security policy? weak" />
<img src="Images/screenshot_admin_authentication.jpg" alt="haha cannot take screenshot because of security policy? weak" /></p>
<p>The 2nd hint from the admin heavily suggested SQL injection, which I suck at and didn't want to try. I spent time instead looking at and analysing the deobfuscated code. Knowledge of Basic Android App Development is assumed. The general structure is that (examples used from User)</p>
<ol>
<li>The Main Activity sets up the Sign Up and Login Fragments
<ol>
<li>Can tell from something like the code below</li>
</ol>
<pre><code>public class b extends FragmentStatePagerAdapter {
     public b(AuthenticationActivity authenticationActivity, FragmentManager fragmentManager) {
         super(fragmentManager);
     }

     @Override // org.sufficientlysecure.rootcommands.PagerAdapter
     public int getCount() {
         return 2;
     }

     @Override // org.androidsoft.app.FragmentStatePagerAdapter
     public Fragment getItem(int i) {
         if (i == 0) {
             return new AbstractFilePickerFragment();
         }
         if (i != 1) {
             return null;
         }
         return new PageFragment();
     }
 }
</code></pre>
</li>
<li>The Sign up Fragment is useless and just sets up the layout
<ol>
<li>The main code</li>
</ol>
<pre><code>public View onCreateView(LayoutInflater layoutInflater, ViewGroup viewGroup, Bundle bundle) {
     ViewGroup $r2 = (ViewGroup) layoutInflater.inflate(R.layout.sign_up_tab_fragment, viewGroup, false);
     EditText editText = (EditText) $r2.findViewById(R.id.user_input);
     EditText editText2 = (EditText) $r2.findViewById(R.id.password_input);
     Button button = (Button) $r2.findViewById(R.id.login_button);
     return $r2;
 }
</code></pre>
</li>
<li>The Login Fragment Sets up the layout
<ol>
<li>The important lines suggesting this are like
<pre><code>this.b.setOnClickListener(new DashboardFragment$1(this, viewGroup2));
this.a.setOnClickListener(new h(this, viewGroup2, $r6));
</code></pre>
</li>
</ol>
</li>
<li>The Hint On Click Listener just returns a static text
<ol>
<li>The important code is</li>
</ol>
<pre><code>public void onClick(View view) {
     Toast.makeText(this.this$0.getContext(), Logger.toString(-9176810696632L), 0).show();
 }
</code></pre>
</li>
<li>The Login On Click Listener has the real logic (and a scam thing to fill in)
<ol>
<li>The important code is</li>
</ol>
<pre><code>public void onClick(View view) {
     String $r5 = this.this$0.c.getText().toString();
     if ($r5.contains(Logger.toString(-9421623832504L))) {
         Toast.makeText(this.g.getContext(), Logger.toString(-9516113113016L), 0).show();
     }
     if (this.h.get(Logger.toString(-9726566510520L), $r5, this.h.getReadableDatabase(Logger.toString(-9700796706744L))).matches(Logger.toString(-9748041347000L))) {
         AlertDialog.Builder $r12 = new AlertDialog.Builder(this.g.getContext());
         View $r1 = LayoutInflater.from(this.g.getContext()).inflate(R.layout.custom_alert, (ViewGroup) null);
         ((TextView) $r1.findViewById(R.id.title)).setText(Logger.toString(-9842530627512L));
         ((TextView) $r1.findViewById(R.id.alert_detail)).setText(Logger.toString(-9885480300472L));
         $r12.setNeutralButton(Logger.toString(-9997149450168L), new a$b$a(this));
         $r12.setPositiveButton(Logger.toString(-10031509188536L), new a$b$b(this));
         $r12.setView($r1);
         $r12.show();
         return;
     }
     Toast.makeText(this.g.getContext(), Logger.toString(-10057278992312L), 0).show();
 }
</code></pre>
</li>
</ol>
<p>For User</p>
<ol>
<li>Main: <code>Deobfuscated/output.apk.zip/sources/net/robotmedia/tech/settings/mobile/User/AuthenticationActivity.java</code></li>
<li>Sign Up Fragment<code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/activity/PageFragment.java</code></li>
<li>Login Fragment<code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/activity/AbstractFilePickerFragment.java</code></li>
<li>Hint On Click Listener: <code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/activity/DashboardFragment$1.java</code></li>
<li>Login On Click Listener: <code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/activity/h.java</code></li>
</ol>
<p>For Admin</p>
<ol>
<li>Main: <code>Deobfuscated/output.apk.zip/sources/net/robotmedia/tech/settings/mobile/Admin/AdminAuthenticationActivity.java</code></li>
<li>Sign Up Fragment: Same as User</li>
<li>Login Fragment: <code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/prefs/b.java</code></li>
<li>Hint On Click Listener: <code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/prefs/DashboardFragment$1.java</code></li>
<li>Login On Click Listener: <code>Deobfuscated/output.apk.zip/sources/de/com/android/android/ui/prefs/h.java</code></li>
</ol>
<p>I started to see these lines/code <code>import roboguice.inject.util.Logger;</code> and <code>Logger.toString(-9700796706744L)</code>. Looking into it more these classes and files are involved in this. I suspect that they are involved in the obfuscation of the strings.</p>
<ol>
<li><code>Deobfuscated/output.apk.zip/sources/roboguice/inject/util/Logger.java</code></li>
<li><code>Deobfuscated/output.apk.zip/sources/roboguice/inject/util/PersistentBase.java</code></li>
<li><code>Deobfuscated/output.apk.zip/sources/roboguice/inject/util/ByteVector.java</code></li>
</ol>
<p>I extracted this decompiled code, ran it on Sololearn's code playground, and decoded the flags. To extract the unicode characters in the Logger class, I had to open the APK in Android Studio and get the bytecode of the approriate class (i used mapping.txt to find the appropriate class matching logger). I used the code in <code>sololearnDecoder.java</code> for Sololearn.</p>
<p><img src="Images/sololearn.jpg" alt="" /></p>
<p>Output</p>
<pre><code>### Started ###
You can't handle the truth!
Password is wrong!
Congrats!
Well done!
### Authentication
# User
My_P@s5w0Rd_iS-L34k3d
Do you think it will be that easy? Muahaha
Congrats!
govtech-csg{eZ_1nJ3CT10N}
Proceed
Close
# Admin
My_P@s5w0Rd_iS-L34k3d_AG41n! T_T
govtech-csg{It5_N0T_Ez_2_L0G_1n_S_AdM1n}
### Ended ###
</code></pre>
<h3>Exported Activities (All about Korovax!)</h3>
<p>I did some research on how to dynamic analysis of Android App, such as using Android Studio.jdwp (which didn't work since I can't connect), adb backups.
Eventually I learnt how to use adb to directly access some Activities. The only activities which are accessible are <code>ViewActivity</code> and <code>Introduction</code>.</p>
<ul>
<li>Since I wanted to be able to access all activities, I used APK Editor Pro (just google) to edit the AndroidManifest, and set <code>android:exported=&quot;true&quot;</code> for all activities. The modified manifest and apk file is in the folder <code>Patched</code> on my Github.</li>
</ul>
<p>Looking at the manifest, it looks like you can pass in data through <code>ViewActivity</code>, but I have no idea how to do that</p>
<p>I tried looking at the <code>UserHomeActivity</code> and <code>TextEditorActivity</code>, but the code doesn't reveal anything or seem suspicious, since they just give text.</p>
<p>Looking closer in the source code of <code>ViewActivity</code>, it references <code>R.string.test</code>, which I suspect could be the flag</p>
<pre><code>      public void onClick(View view) {
            if (ViewActivity.this.next() == 1720543) {
                AlertDialog.Builder $r3 = new AlertDialog.Builder(ViewActivity.this);
                View $r1 = LayoutInflater.from(ViewActivity.this).inflate(R.layout.custom_alert, (ViewGroup) null);
                ((TextView) $r1.findViewById(R.id.title)).setText(&quot;Congrats!&quot;);
                ((TextView) $r1.findViewById(R.id.alert_detail)).setText(R.string.test);
                de.com.android.android.ui.activity.b.a().onCreate(true);
                $r3.setNeutralButton(&quot;Proceed&quot;, new DialogInterface$OnClickListenerC0008a());
                $r3.setPositiveButton(&quot;Close&quot;, new b());
                $r3.setView($r1);
                $r3.show();
                return;
            }
            Toast.makeText(ViewActivity.this, &quot;Something's happening...&quot;, 0).show();
            Toast.makeText(ViewActivity.this, &quot;Maybe not.&quot;, 0).show();
        }
</code></pre>
<p>For Android, static values can be stored in xml files <code>strings.xml</code>, <code>values.xml</code> and stuff like that, mainly in <code>res/values</code>. Looking at <code>strings.xml</code> for the string <code>test</code>, you get</p>
<pre><code>&lt;string name=&quot;test&quot;&gt;Z292dGVjaC1jc2d7SV9oMFAzX3VfRDFEX04wVF9DbDFjS19VUl9XQHlfSDNyM30=&lt;/string&gt;
</code></pre>
<p>This looks like base64 (since it has <code>=</code> at the end to show padding, and the character set consists mainly of the characters in base64 data like letters). Decoding it using an online tool gives <code>govtech-csg{I_h0P3_u_D1D_N0T_Cl1cK_UR_W@y_H3r3}</code>.</p>
<p>Too bad I clicked my way here.</p>
<h3>SHA-1 Decoding</h3>
<p>Looking at <code>AdminHome.java</code> for the Activity there are some interesting variables functions</p>
<pre><code>public String mFolder = getPasswordHash();
</code></pre>
<pre><code>   .....
      public void onClick(View view) {
            AdminHome $r2 = AdminHome.this;
            $r2.mPassword = (EditText) $r2.findViewById(R.id.editText_enteredFlag);
            if (AdminHome.this.hash(AdminHome.this.getValue(AdminHome.this.mPassword.getText().toString())).equalsIgnoreCase(AdminHome.this.mFolder)) {
                AlertDialog.Builder $r7 = new AlertDialog.Builder(AdminHome.this);
                View $r1 = LayoutInflater.from(AdminHome.this).inflate(R.layout.custom_alert, (ViewGroup) null);
                ((TextView) $r1.findViewById(R.id.title)).setText(&quot;Congrats!&quot;);
                ((TextView) $r1.findViewById(R.id.alert_detail)).setText(&quot;Add govtech-csg{} to what you found!&quot;);
                $r7.setNeutralButton(&quot;Proceed&quot;, new a());
                $r7.setPositiveButton(&quot;Close&quot;, new b());
                $r7.setView($r1);
                $r7.show();
                Toast.makeText(AdminHome.this.getApplicationContext(), &quot;Flag is correct!&quot;, 0).show();
                return;
            }
            Toast.makeText(AdminHome.this.getApplicationContext(), &quot;Flag is wrong!&quot;, 0).show();
        }
    }
   
    public native String getPasswordHash();

    public final String getValue(String $r1) {
        if (!$r1.contains(&quot;govtech-csg{&quot;)) {
            return $r1;
        }
        String $r12 = $r1.replace(&quot;govtech-csg{&quot;, BuildConfig.FLAVOR);
        return $r12.substring(0, $r12.length() - 1);
    }

   public String hash(String str) {
        try {
            MessageDigest $r3 = MessageDigest.getInstance(&quot;SHA-1&quot;);
            byte[] $r4 = str.getBytes(SQLiteDatabase.KEY_ENCODING);
            $r3.update($r4, 0, $r4.length);
            return bytesToHex($r3.digest());
        } catch (NoSuchAlgorithmException e) {
            System.out.println(&quot;Algorithm not recognised&quot;);
            return null;
        } catch (UnsupportedEncodingException e2) {
            System.out.println(&quot;Something is wrong. Like really.&quot;);
            return null;
        }
    }
</code></pre>
<p>Looking at it it seems like it gets the text filled in the search bar with id <code>R.id.editText_enteredFlag</code>, hashes it in <code>SHA-1</code> and compares it with the password hash from the native function <code>getPasswordHash()</code>. If they match you succeed.</p>
<p>I then checked the native decompiled code from the native library</p>
<p><img src="Images/code_native_2.jpg" alt="" /></p>
<p>I got the string <code>b7c1020edc5d4ab5ce059909f0a7bd73b3de005b</code>. I then passed it through crackstation to find the password from the <code>SHA-1</code> hash</p>
<p><img src="Images/crackstation.jpg" alt="" /></p>
<p>Putting it in the app gives success</p>
<p><img src="Images/screenshot_admin_search_success.jpg" alt="" /></p>
<h3>My Thought process</h3>
<p>When trying to solve the Mobile Challenges, I didn't really solve it in this order. What actually happened was more like this</p>
<ol>
<li>Decompiling the code, Installing the app, finding native libraries and opening them in Cutter (underated C decompiler)
<ol>
<li>Spent time looking at the Info Page before realising I'm supposed to look at the Contact Activity</li>
</ol>
</li>
<li>Deobfuscating the code using an online tool</li>
<li>Opening the APK up in Android Studio, trying and failing to do debugging and dynamic analysis</li>
<li>Try to use JDWP to debug (and Failed)</li>
<li>Making a backup using ADB, opening it in DB Browser and finding out it is corrupted and useless
<ol>
<li>After the competition I was told that it is actually encrupted instead</li>
</ol>
</li>
<li>Learn to use ADB to access exposed Activities
<ol>
<li>Ended up accessing <code>sg.gov.tech.ctf.User.ViewActivity</code>, reversing the code, extracting the flag from <code>strings.xml</code> and solving <code>All about Korovax!</code></li>
<li>Also learnt and experimented with drozer (a tool to help with analysis)</li>
</ol>
</li>
<li><del>Pirate</del> Use APK Editor Pro to edit the APK and export all activities (for easy access in apk)</li>
<li>Taking the hint to <code>Welcome to Korovax Mobile!</code> (which was useless), but forced me to look harder into the program and actually reverse it</li>
<li>Reversing <code>sg.gov.tech.ctf.Admin.AdminHome</code> and obtaining the flag</li>
<li>Randomly putting in the flag I obtained, and then remembering I solved <code>All about Korovax!</code></li>
</ol>
<p>This took about the entire day, but I learnt quite a lot in the process.</p>
<h2>Flags</h2>
<ol>
<li>Contact Me!: <code>govtech-csg{Ez_F1aG_4_wARmUp!}</code></li>
<li>Subscribe!: <code>govtech-csg{th3rE_15_nO_n0bIliTy_In_p0Vert7}</code></li>
<li>Welcome to Korovax Mobile!: <code>govtech-csg{eZ_1nJ3CT10N}</code>
<ol>
<li>Except no injection</li>
</ol>
</li>
<li>True or False: <code>govtech-csg{It5_N0T_Ez_2_L0G_1n_S_AdM1n}</code>
<ol>
<li>That's why don't login as admin just hack your way through</li>
</ol>
</li>
<li>What's with the Search!: <code>govtech-csg{qqww1122}</code></li>
<li>All about Korovax: <code>govtech-csg{I_h0P3_u_D1D_N0T_Cl1cK_UR_W@y_H3r3}</code>
<ol>
<li>I did. Too bad!</li>
</ol>
</li>
</ol>

    </div>
    
    </div>

  </body>
</html>